
<!DOCTYPE html>
<html lang="en" class="dark">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Modern KPI Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              'brand-primary': '#6366F1', // Indigo 500
              'brand-secondary': '#EC4899', // Pink 500
              'brand-success': '#10B981', // Emerald 500
              'brand-danger': '#EF4444', // Red 500
              'brand-warning': '#F59E0B', // Amber 500
              
              // Dark Theme
              'dark-bg': '#0F172A', // Slate 900
              'dark-card': '#1E293B', // Slate 800
              'dark-border': '#334155', // Slate 700
              'dark-text-primary': '#F8FAFC', // Slate 50
              'dark-text-secondary': '#94A3B8', // Slate 400

              // Light Theme
              'light-bg': '#F1F5F9', // Slate 100
              'light-card': '#FFFFFF', // White
              'light-border': '#E2E8F0', // Slate 200
              'light-text-primary': '#0F172A', // Slate 900
              'light-text-secondary': '#64748B', // Slate 500
            },
            fontFamily: {
                sans: ['Inter', 'sans-serif'],
            },
            keyframes: {
              slideIn: {
                '0%': { transform: 'translateY(100%)', opacity: '0' },
                '100%': { transform: 'translateY(0)', opacity: '1' },
              },
              slideOut: {
                '0%': { transform: 'translateY(0)', opacity: '1' },
                '100%': { transform: 'translateY(100%)', opacity: '0' },
              },
            },
            animation: {
              slideIn: 'slideIn 0.5s ease-out forwards',
              slideOut: 'slideOut 0.5s ease-in forwards',
            }
          }
        }
      }
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.1.1/",
    "react/": "https://aistudiocdn.com/react@^19.1.1/",
    "react": "https://aistudiocdn.com/react@^19.1.1",
    "recharts/": "https://aistudiocdn.com/recharts@^3.2.1/",
    "recharts": "https://aistudiocdn.com/recharts@^3.2.1",
    "xlsx": "https://cdn.sheetjs.com/xlsx-latest/package/xlsx.mjs",
    "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
    "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js",
    "firebase/analytics": "https://www.gstatic.com/firebasejs/10.8.0/firebase-analytics.js"
  }
}
</script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
  <body class="bg-light-bg text-light-text-primary dark:bg-dark-bg dark:text-dark-text-primary font-sans">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// Import external dependencies
import React, { useState, useEffect, useRef, useMemo, createContext, useContext } from 'react';
import ReactDOM from 'react-dom/client';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, LabelList, LineChart, Line, Legend } from 'recharts';
import { read, utils } from 'xlsx';
import { initializeApp } from 'firebase/app';
import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from 'firebase/firestore';
import { getAnalytics } from 'firebase/analytics';

// ===================================================
// START: Firebase Configuration & Service
// ===================================================

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBHguqBiwres4qMDstnaq-4KYQiRb0JTgE",
  authDomain: "admin-wh1.firebaseapp.com",
  projectId: "admin-wh1",
  storageBucket: "admin-wh1.appspot.com",
  messagingSenderId: "1072795813221",
  appId: "1:1072795813221:web:e27f6787c25c734d83cd8c",
  measurementId: "G-CEK74QFCW8"
};

// Initialize Firebase variables
let app;
let db;
let analytics;

// Initialize Firebase
try {
  app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  analytics = getAnalytics(app);
  console.log('Firebase initialized successfully');
} catch (error) {
  console.error('Error initializing Firebase:', error);
  // ถ้าเกิดข้อผิดพลาด ให้แสดงข้อความแจ้งเตือนผู้ใช้
  alert('ไม่สามารถเชื่อมต่อกับ Firebase ได้ กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ตและลองใหม่อีกครั้ง');
}

// กำหนดชื่อ Collections แยกตามเมนู
const COLLECTIONS = {
  KPI: 'kpi_reports',
  CONSUMABLES: 'consumables_reports',
  OT: 'ot_reports',
  LEAVE: 'leave_reports',
  ACCIDENT: 'accident_reports',
  WORKLOAD: 'workload_reports'
};

// โครงสร้างข้อมูลเริ่มต้นสำหรับแต่ละเมนู
const defaultData = {
  kpi: {
    kpis: [],
    chartData: [],
    tableRows: [],
    lastUpdated: new Date()
  },
  consumables: {
    tableData: [],
    kpis: [],
    chartData: [],
    lastUpdated: new Date()
  },
  ot: {
    tableData: [],
    kpis: [],
    chartData: [],
    lastUpdated: new Date()
  },
  leave: {
    tableData: [],
    kpis: [],
    chartData: [],
    lastUpdated: new Date()
  },
  accident: {
    tableData: [],
    kpis: [],
    chartData: [],
    lastUpdated: new Date()
  },
  workload: {
    data: [],
    lastUpdated: new Date()
  }
};

const firebaseService = {
  // ฟังก์ชันสำหรับสร้าง document ID แบบอัตโนมัติตามเดือนและปี
  generateDocId: () => {
    const now = new Date();
    return `${now.getFullYear()}_${String(now.getMonth() + 1).padStart(2, '0')}`;
  },

  // ฟังก์ชันสำหรับดึง reference ของ document
  getDocRef: (collection, docId = firebaseService.generateDocId()) => {
    return doc(db, collection, docId);
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูล KPI
  updateKpi: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.KPI);
    await setDoc(docRef, { ...defaultData.kpi, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูลวัสดุสิ้นเปลือง
  updateConsumables: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.CONSUMABLES);
    await setDoc(docRef, { ...defaultData.consumables, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูล OT
  updateOt: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.OT);
    await setDoc(docRef, { ...defaultData.ot, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูลการลา
  updateLeave: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.LEAVE);
    await setDoc(docRef, { ...defaultData.leave, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูลอุบัติเหตุ
  updateAccident: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.ACCIDENT);
    await setDoc(docRef, { ...defaultData.accident, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับสร้างหรืออัพเดทข้อมูล Workload
  updateWorkload: async (data) => {
    const docRef = firebaseService.getDocRef(COLLECTIONS.WORKLOAD);
    await setDoc(docRef, { ...defaultData.workload, ...data, lastUpdated: new Date() });
  },

  // ฟังก์ชันสำหรับดึงข้อมูลล่าสุดของแต่ละเมนู
  getLatestData: async (collection) => {
    const docRef = firebaseService.getDocRef(collection);
    const docSnap = await getDoc(docRef);
    return docSnap.exists() ? docSnap.data() : null;
  }
};

// ===================================================
// END: Firebase Configuration & Service
// ===================================================


// ===================================================
// START: Utility Functions
// ===================================================

/**
 * Deeply sanitizes an object, removing any circular references and converting
 * Firestore Timestamps to JS Date objects. This is crucial for safely setting
 * state, especially when Firestore is in offline mode.
 * @param {any} obj The object to sanitize.
 * @param {WeakMap} [seen=new WeakMap()] Used internally to track visited objects.
 * @returns {any} The sanitized object.
 */
const sanitizeData = (obj, seen = new WeakMap()) => {
    if (obj === null || typeof obj !== 'object') {
        return obj;
    }
    // Convert Firestore Timestamps
    if (typeof obj.toDate === 'function') {
        return obj.toDate();
    }
    // Detect and break circular references
    if (seen.has(obj)) {
        return undefined; 
    }
    seen.set(obj, true);

    if (Array.isArray(obj)) {
        const newArr = [];
        for (const item of obj) {
            newArr.push(sanitizeData(item, seen));
        }
        return newArr;
    }

    const newObj = {};
    for (const key in obj) {
        if (Object.prototype.hasOwnProperty.call(obj, key)) {
            const sanitizedValue = sanitizeData(obj[key], seen);
            if (sanitizedValue !== undefined) {
                newObj[key] = sanitizedValue;
            }
        }
    }
    return newObj;
};

// ===================================================
// END: Utility Functions
// ===================================================


// ===================================================
// START: i18n/translations.ts
// ===================================================
const translations = {
    en: {
        // Sidebar
        'kpiReport': 'KPI Report',
        'consumablesReport': 'Consumables Report',
        'otReport': 'OT Report',
        'leaveReport': 'Leave Report',
        'accidentReport': 'Accident Report',
        'workloadReport': 'Workload Report',
        'reports': 'Reports',
        'documents': 'Documents',
        'settings': 'Settings',
        'helpCenter': 'Help Center',
        'analytics': 'Analytics',
        // Header
        'search': 'Search...',
        'uploadKpiData': 'Upload KPI Data',
        'live': 'Live',
        'connecting': 'Connecting...',
        'offline': 'Offline',
        'userName': 'Jane Doe',
        'userRole': 'Admin',
        // KPI Card
        'vsLastMonth': 'vs last month',
        // Main Chart
        'kpiProgressOverview': 'KPI Progress Overview',
        // Data Table
        'kpiDetails': 'KPI Details',
        'searchDetails': 'Search details...',
        'kpi': 'KPI',
        'target': 'Target',
        'score': 'Score',
        'result': 'Result',
        'noResultsFound': 'No results found.',
        // Consumables Report
        'uploadExcel': 'Upload Excel',
        'noDataLoaded': 'No Data Loaded',
        'noDataLoadedMessageConsumables': 'Please upload an Excel file using the button above to view the report.',
        'monthlyConsumablesCost': 'Monthly Consumables Cost',
        'top5FrequentItems': 'Top 5 Frequent Items',
        'frequency': 'Frequency',
        'totalCost': 'Total Cost',
        'costByDepartment': 'Cost by Department',
        'department': 'Department',
        'recentTransactions': 'Recent Transactions',
        'searchTransactions': 'Search transactions...',
        // OT Report
        'noDataLoadedMessageOT': 'Please upload an Excel file using the button above to view the OT report.',
        'monthlyOvertimeHours': 'Monthly Overtime Hours',
        'top10EmployeesByOT': 'Top 10 Employees by OT',
        'name': 'Name',
        'totalHours': 'Total Hours',
        'top10DepartmentsByOT': '10 Departments by OT',
        'employeeOTDetails': 'Employee OT Details',
        'searchEmployees': 'Search employees...',
        // Leave Report
        'noDataLoadedMessageLeave': 'Please upload an Excel file using the button above to view the Leave report.',
        'monthlyLeaveDays': 'Monthly Leave Days',
        'top10LeaveEmployees': 'Top 10 Employees by Leave',
        'days': 'Days',
        'top5LeaveTypes': 'Top 5 Leave Types',
        'leaveType': 'Leave Type',
        'top5LeaveDepartments': '5 Top Departments by Leave',
        'employeeLeaveDetails': 'Employee Leave Details',
        // Accident Report
        'noDataLoadedMessageAccident': 'Please upload an Excel file using the button above to view the Accident report.',
        'accidentsByDepartment': 'Accidents by Department',
        'accidentDetails': 'Accident Details',
        'searchAccidents': 'Search accidents...',
        // Workload Report
        'workloadByProduct': 'Workload by Product (Ton/Person/Hr.)',
        'avgWorkloadRaw': 'Avg. Ton/Hr (Raw Material)',
        'avgWorkloadCoil': 'Avg. Ton/Hr (Coil)',
        'avgWorkloadFilm': 'Avg. Ton/Hr (Film&Scrap)',
        'workloadDetails': 'Workload Details',
        'product': 'Product',
        'description': 'Description',
        'unit': 'Unit',
        // Placeholder
        'underConstruction': 'This page is under construction.',
        // General
        'pass': 'PASS',
        'inProgress': 'In Progress',
        'toastSuccess': 'Dashboard updated successfully!',
        // Error Screen
        'dbConnectionFailed': 'Database Connection Failed',
        'dbConnectionFailedMessage': "Could not connect to the database. The app will work in offline mode with cached data, but changes won't be saved.",
        'errorDetails': 'Error Details',
        'errorCode': 'Code',
        'errorMessage': 'Message',
        'possibleSolution': 'Possible Solution',
        'suggestionPermissionDenied': "This is a 'permission-denied' error, which is very common for new projects. Please check your Firestore Security Rules in the Firebase console. For development, you can set them to allow reads and writes:",
        'suggestionUnavailable': "The Firestore backend is unavailable or the network is weak. Check your internet connection. A firewall might be blocking the connection.",
        'suggestionDefault': "Please check your internet connection and ensure your Firebase project (ID: 'admin-wh1') is set up correctly, including creating a Firestore database in the correct region."
    },
    th: {
        // Sidebar
        'kpiReport': 'รายงาน KPI',
        'consumablesReport': 'รายงานวัสดุสิ้นเปลือง',
        'otReport': 'รายงาน OT',
        'leaveReport': 'รายงานการลา',
        'accidentReport': 'รายงานอุบัติเหตุ',
        'workloadReport': 'ปริมาณการทำงานต่อคน',
        'reports': 'รายงานอื่นๆ',
        'documents': 'เอกสาร',
        'settings': 'ตั้งค่า',
        'helpCenter': 'ศูนย์ช่วยเหลือ',
        'analytics': 'การวิเคราะห์',
        // Header
        'search': 'ค้นหา...',
        'uploadKpiData': 'อัปโหลดข้อมูล KPI',
        'live': 'ออนไลน์',
        'connecting': 'กำลังเชื่อมต่อ...',
        'offline': 'ออฟไลน์',
        'userName': 'เจน โด',
        'userRole': 'ผู้ดูแลระบบ',
        // KPI Card
        'vsLastMonth': 'เทียบกับเดือนที่แล้ว',
        // Main Chart
        'kpiProgressOverview': 'ภาพรวมความคืบหน้า KPI',
        // Data Table
        'kpiDetails': 'รายละเอียด KPI',
        'searchDetails': 'ค้นหารายละเอียด...',
        'kpi': 'KPI',
        'target': 'เป้าหมาย',
        'score': 'คะแนน',
        'result': 'ผลลัพธ์',
        'noResultsFound': 'ไม่พบผลลัพธ์',
        // Consumables Report
        'uploadExcel': 'อัปโหลด Excel',
        'noDataLoaded': 'ไม่มีข้อมูล',
        'noDataLoadedMessageConsumables': 'กรุณาอัปโหลดไฟล์ Excel เพื่อดูรายงาน',
        'monthlyConsumablesCost': 'ค่าใช้จ่ายวัสดุสิ้นเปลืองรายเดือน',
        'top5FrequentItems': '5 อันดับรายการที่ใช้บ่อยที่สุด',
        'frequency': 'ความถี่',
        'totalCost': 'ต้นทุนรวม',
        'costByDepartment': 'ค่าใช้จ่ายตามแผนก',
        'department': 'แผนก',
        'recentTransactions': 'ธุรกรรมล่าสุด',
        'searchTransactions': 'ค้นหาธุรกรรม...',
        // OT Report
        'noDataLoadedMessageOT': 'กรุณาอัปโหลดไฟล์ Excel เพื่อดูรายงาน OT',
        'monthlyOvertimeHours': 'ชั่วโมงล่วงเวลาแต่ละเดือน',
        'top10EmployeesByOT': '10 อันดับพนักงานที่ทำ OT สูงสุด',
        'name': 'ชื่อ',
        'totalHours': 'ชั่วโมงรวม',
        'top10DepartmentsByOT': '10 อันดับแผนกที่ทำ OT สูงสุด',
        'employeeOTDetails': 'รายละเอียด OT ของพนักงาน',
        'searchEmployees': 'ค้นหาพนักงาน...',
        // Leave Report
        'noDataLoadedMessageLeave': 'กรุณาอัปโหลดไฟล์ Excel เพื่อดูรายงานการลา',
        'monthlyLeaveDays': 'จำนวนวันลาแต่ละเดือน',
        'top10LeaveEmployees': '10 อันดับพนักงานที่ลามากที่สุด',
        'days': 'วัน',
        'top5LeaveTypes': '5 อันดับประเภทการลา',
        'leaveType': 'ประเภทการลา',
        'top5LeaveDepartments': '5 อันดับส่วนงานที่ลามากที่สุด',
        'employeeLeaveDetails': 'รายละเอียดการลาของพนักงาน',
        // Accident Report
        'noDataLoadedMessageAccident': 'กรุณาอัปโหลดไฟล์ Excel เพื่อดูรายงานอุบัติเหตุ',
        'accidentsByDepartment': 'อุบัติเหตุตามส่วนงาน',
        'accidentDetails': 'รายละเอียดอุบัติเหตุ',
        'searchAccidents': 'ค้นหาอุบัติเหตุ...',
        // Workload Report
        'workloadByProduct': 'ปริมาณงานตามผลิตภัณฑ์ (ตัน/คน/ชม.)',
        'avgWorkloadRaw': 'เฉลี่ย Ton/Hr (Raw Material)',
        'avgWorkloadCoil': 'เฉลี่ย Ton/Hr (Coil)',
        'avgWorkloadFilm': 'เฉลี่ย Ton/Hr (Film&Scrap)',
        'workloadDetails': 'รายละเอียดปริมาณงาน',
        'product': 'ผลิตภัณฑ์',
        'description': 'คำอธิบาย',
        'unit': 'หน่วย',
        // Placeholder
        'underConstruction': 'หน้านี้กำลังอยู่ระหว่างการพัฒนา',
        // General
        'pass': 'ผ่าน',
        'inProgress': 'ดำเนินการอยู่',
        'toastSuccess': 'อัปเดตแดชบอร์ดสำเร็จ!',
        // Error Screen
        'dbConnectionFailed': 'การเชื่อมต่อฐานข้อมูลล้มเหลว',
        'dbConnectionFailedMessage': 'ไม่สามารถเชื่อมต่อกับฐานข้อมูลได้ แอปจะทำงานในโหมดออฟไลน์ด้วยข้อมูลที่แคชไว้ แต่การเปลี่ยนแปลงจะไม่ถูกบันทึก',
        'errorDetails': 'รายละเอียดข้อผิดพลาด',
        'errorCode': 'รหัส',
        'errorMessage': 'ข้อความ',
        'possibleSolution': 'แนวทางการแก้ไขที่เป็นไปได้',
        'suggestionPermissionDenied': 'เกิดข้อผิดพลาด \'permission-denied\' (ไม่มีสิทธิ์เข้าถึง) ซึ่งเป็นปัญหาที่พบบ่อยมากสำหรับโปรเจกต์ใหม่ กรุณาตรวจสอบ Firestore Security Rules ใน Firebase console ของคุณ สำหรับการพัฒนา คุณสามารถตั้งค่าให้อนุญาตการอ่านและเขียนได้ดังนี้:',
        'suggestionUnavailable': 'ไม่สามารถเข้าถึง Firestore ได้ในขณะนี้ หรือการเชื่อมต่อเครือข่ายไม่เสถียร กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต และตรวจสอบว่ามีไฟร์วอลล์บล็อกการเชื่อมต่อหรือไม่',
        'suggestionDefault': 'กรุณาตรวจสอบการเชื่อมต่ออินเทอร์เน็ต และตรวจสอบให้แน่ใจว่าโปรเจกต์ Firebase (ID: \'admin-wh1\') ของคุณถูกตั้งค่าอย่างถูกต้อง รวมถึงการสร้างฐานข้อมูล Firestore ใน region ที่ถูกต้องด้วย'
    }
};

const getInitialState = (key, defaultValue) => {
    try {
        const storedValue = localStorage.getItem(key);
        if (storedValue) {
            return JSON.parse(storedValue);
        }
    } catch (error) {
        console.error(`Error reading "${key}" from localStorage`, error);
        localStorage.removeItem(key);
    }
    return defaultValue;
};

const LanguageContext = createContext(null);
const LanguageProvider = ({ children }) => {
    const [language, setLanguage] = useState(getInitialState('language', 'en'));
    useEffect(() => {
        localStorage.setItem('language', JSON.stringify(language));
        document.documentElement.style.fontFamily = language === 'th' ? "'Sarabun', sans-serif" : "'Inter', sans-serif";
    }, [language]);
    const toggleLanguage = () => {
        setLanguage(lang => (lang === 'en' ? 'th' : 'en'));
    };
    const t = (key) => {
        return translations[language][key] || key;
    };
    return (
        <LanguageContext.Provider value={{ language, toggleLanguage, t }}>
            {children}
        </LanguageContext.Provider>
    );
};
const useTranslation = () => useContext(LanguageContext);
// ===================================================
// END: i18n/translations.ts
// ===================================================


// ===================================================
// START: components/icons/Icons.tsx
// ===================================================
const Bars3Icon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
    </svg>
);
const XMarkIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M6 18 18 6M6 6l12 12" />
    </svg>
);
const ArchiveBoxIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="m20.25 7.5-.625 10.632a2.25 2.25 0 0 1-2.247 2.118H6.622a2.25 2.25 0 0 1-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125Z" />
    </svg>
);
const BuildingOfficeIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3.75 21h16.5M4.5 3h15M5.25 3v18m13.5-18v18M9 6.75h1.5m-1.5 3h1.5m-1.5 3h1.5m3-6h1.5m-1.5 3h1.5m-1.5 3h1.5M6.75 21v-2.25a2.25 2.25 0 0 1 2.25-2.25h6a2.25 2.25 0 0 1 2.25 2.25V21m-2.25-18-2.25.002" />
    </svg>
);
const ArrowTrendingDownIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
  </svg>
);
const ArrowTrendingUpIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 6 9 12.75l4.286-4.286a11.948 11.948 0 0 1 5.814 5.518l2.74-1.22m0 0-5.94-2.281m5.94 2.28-2.28 5.941" />
  </svg>
);
const BellIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
  </svg>
);
const ChartBarIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" />
  </svg>
);
const CurrencyDollarIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v12m-3-2.818.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
  </svg>
);
const MagnifyingGlassIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
  </svg>
);
const MinusIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M5 12h14" />
    </svg>
);
const ShoppingCartIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 0 0-3 3h15.75m-12.75-3h11.218c.51 0 .962-.343 1.087-.835l1.838-5.513a1.875 1.875 0 0 0-1.097-2.288H5.64M7.5 14.25 5.106 5.106M15 21a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Zm0 0h-5.64m5.64 0-1.03-4.125M9 21a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0Z" />
  </svg>
);
const UsersIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.226A6.668 6.668 0 0 0 12 14.25a6.668 6.668 0 0 0-3.468-.985m7.5 0a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1-4.682-2.72M12 12.75a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm0 0a9.094 9.094 0 0 0-3.741-.479 3 3 0 0 0-4.682-2.72M6.344 18.72a9.094 9.094 0 0 1-3.741-.479 3 3 0 0 1 4.682-2.72M12 12.75a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z" />
  </svg>
);
const UserGroupIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m-7.5-2.226A6.668 6.668 0 0 0 12 14.25a6.668 6.668 0 0 0-3.468-.985m7.5 0a9.094 9.094 0 0 1 3.741-.479 3 3 0 0 1-4.682-2.72m-12 2.226A6.668 6.668 0 0 1 12 14.25a6.668 6.668 0 0 1 3.468-.985m-7.5 0a9.094 9.094 0 0 0-3.741-.479 3 3 0 0 0 4.682-2.72M9 12.75a3 3 0 1 1 0-6 3 3 0 0 1 0 6Zm0 0a9.094 9.094 0 0 1-3.741-.479 3 3 0 0 1-4.682-2.72m0 0a9.094 9.094 0 0 0 3.741.479 3 3 0 0 0-4.682 2.72m7.5-2.226A6.668 6.668 0 0 0 12 14.25a6.668 6.668 0 0 0-3.468-.985" />
  </svg>
);
const HomeIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h7.5" />
    </svg>
);
const ChartPieIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z" />
    </svg>
);
const DocumentTextIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
    </svg>
);
const Cog6ToothIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 0 1 1.37.49l1.296 2.247a1.125 1.125 0 0 1-.26 1.431l-1.003.827c-.293.24-.438.613-.438.995s.145.755.438.995l1.003.827c.424.35.534.954.26 1.431l-1.296 2.247a1.125 1.125 0 0 1-1.37.49l-1.217-.456c-.355-.133-.75-.072-1.075.124a6.57 6.57 0 0 1-.22.127c-.332.183-.582.495-.645.87l-.213 1.281c-.09.543-.56.94-1.11.94h-2.593c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.063-.374-.313-.686-.645-.87a6.52 6.52 0 0 1-.22-.127c-.324-.196-.72-.257-1.075-.124l-1.217.456a1.125 1.125 0 0 1-1.37-.49l-1.296-2.247a1.125 1.125 0 0 1 .26-1.431l1.004-.827c.292-.24.437-.613.437-.995s-.145-.755-.437-.995l-1.004-.827a1.125 1.125 0 0 1-.26-1.431l1.296-2.247a1.125 1.125 0 0 1 1.37-.49l1.217.456c.355.133.75.072 1.075-.124.072-.044.146-.087.22-.127.332-.183.582-.495.645-.87l.213-1.281Z" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" />
    </svg>
);
const QuestionMarkCircleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 5.25h.008v.008H12v-.008Z" />
    </svg>
);
const BoltIcon = (props) => (
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
    <path strokeLinecap="round" strokeLinejoin="round" d="m3.75 13.5 10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75Z" />
  </svg>
);
const ArrowUpTrayIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
    </svg>
);
const ClipboardDocumentListIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 0 0 2.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 4.8424 0 0 0-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 0 0 .75-.75c0-.231-.035-.454-.1-.664M18.75 19.5H5.25A2.25 2.25 0 0 1 3 17.25V9h16.5v8.25c0 1.242-1.008 2.25-2.25 2.25Z" />
    </svg>
);
const ClockIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
    </svg>
);
const CalendarDaysIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M-4.5 12h22.5" />
    </svg>
);
const ClipboardDocumentCheckIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M10.125 2.25h-4.5c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125v-9M10.125 2.25h.375a9 9 0 0 1 9 9v.375M10.125 2.25A3.375 3.375 0 0 1 13.5 5.625v1.5c0 .621.504 1.125 1.125 1.125h1.5a3.375 3.375 0 0 1 3.375 3.375M9 15l2.25 2.25L15 12" />
    </svg>
);
const ExclamationTriangleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
    </svg>
);
const SunIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M12 3v2.25m6.364.386-1.591 1.591M21 12h-2.25m-.386 6.364-1.591-1.591M12 18.75V21m-4.773-4.227-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" />
    </svg>
);
const MoonIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M21.752 15.002A9.72 9.72 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
    </svg>
);
const WifiIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M8.288 15.038a5.25 5.25 0 0 1 7.424 0M5.106 11.856c3.807-3.808 9.98-3.808 13.788 0M1.924 8.674c5.565-5.565 14.587-5.565 20.152 0M12.53 18.22l-.53.53-.53-.53a.75.75 0 0 1 1.06 0Z" />
    </svg>
);
const WifiSlashIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M15.182 15.182a4.5 4.5 0 0 1-6.364 0M17.486 12.914a9 9 0 0 1-10.972 0M19.79 10.646a13.5 13.5 0 0 1-15.58 0M21 21l-9-9-9 9" />
        <path strokeLinecap="round" strokeLinejoin="round" d="M4.03 8.968a13.5 13.5 0 0 1 15.94 0M8.465 13.393a4.5 4.5 0 0 1 7.07 0" />
    </svg>
);

const CheckCircleIcon = (props) => (
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor" {...props}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
    </svg>
);
// ===================================================
// END: components/icons/Icons.tsx
// ===================================================


// ===================================================
// START: constants.tsx
// ===================================================
const parseValue = (val) => {
    if (val === '-' || val === '#DIV/0!' || val == null || String(val).trim() === '') return null;
    if (typeof val === 'number') return val;
    if (typeof val === 'string') {
        const num = parseFloat(val.replace(/,/g, ''));
        return isNaN(num) ? null : num;
    }
    return null;
};
// ===================================================
// END: constants.tsx
// ===================================================


// ===================================================
// START: components/KPICard.tsx
// ===================================================
const IconComponent = ({ name, className }) => {
    switch (name) {
        case 'CurrencyDollarIcon': return <CurrencyDollarIcon className={className} />;
        case 'ShoppingCartIcon': return <ShoppingCartIcon className={className} />;
        case 'UsersIcon': return <UsersIcon className={className} />;
        case 'UserGroupIcon': return <UserGroupIcon className={className} />;
        case 'ChartBarIcon': return <ChartBarIcon className={className} />;
        case 'ArchiveBoxIcon': return <ArchiveBoxIcon className={className} />;
        case 'BuildingOfficeIcon': return <BuildingOfficeIcon className={className} />;
        case 'DocumentTextIcon': return <DocumentTextIcon className={className} />;
        case 'ClockIcon': return <ClockIcon className={className} />;
        case 'ClipboardDocumentCheckIcon': return <ClipboardDocumentCheckIcon className={className} />;
        case 'ExclamationTriangleIcon': return <ExclamationTriangleIcon className={className} />;
        default: return null;
    }
};
const KPICard = ({ title, value, trend, trendDirection = 'neutral', icon, color }) => {
  const { t } = useTranslation();
  const TrendIcon = () => {
    switch (trendDirection) {
      case 'up':
        return <ArrowTrendingUpIcon className="h-5 w-5 text-brand-success" />;
      case 'down':
        return <ArrowTrendingDownIcon className="h-5 w-5 text-brand-danger" />;
      default:
        return <MinusIcon className="h-5 w-5 text-light-text-secondary dark:text-dark-text-secondary" />;
    }
  };
  const trendColor = trendDirection === 'up' ? 'text-brand-success' : trendDirection === 'down' ? 'text-brand-danger' : 'text-light-text-secondary dark:text-dark-text-secondary';
  return (
    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl p-6 flex flex-col gap-4 transform hover:-translate-y-1 transition-transform duration-300 shadow-lg">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-medium text-light-text-secondary dark:text-dark-text-secondary">{title}</h3>
        <div className={color}>
          <IconComponent name={icon} className="h-8 w-8" />
        </div>
      </div>
      <div>
        <p className="text-4xl font-bold text-light-text-primary dark:text-dark-text-primary">{value}</p>
      </div>
      {trend && (
        <div className="flex items-center gap-2 text-md">
          <TrendIcon />
          <span className={trendColor}>{trend}</span>
          <span className="text-light-text-secondary dark:text-dark-text-secondary">{t('vsLastMonth')}</span>
        </div>
      )}
    </div>
  );
};
// ===================================================
// END: components/KPICard.tsx
// ===================================================


// ===================================================
// START: components/MainChart.tsx
// ===================================================
const CustomTooltip = ({ active, payload, label }) => {
  if (active && payload && payload.length) {
    return (
      <div className="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm p-4 border border-light-border dark:border-dark-border rounded-lg shadow-lg">
        <p className="label text-lg font-semibold text-light-text-primary dark:text-dark-text-primary">{`${label}`}</p>
        <p className="intro text-brand-primary">{`Value : ${payload[0].value?.toLocaleString()}`}</p>
      </div>
    );
  }
  return null;
};
const DataLabel = (props) => {
    const { x, y, width, value, theme } = props;
    const textColor = theme === 'dark' ? '#94A3B8' : '#64748B';
    if (value === 0 || !value) {
        return null;
    }
    const formattedValue = value.toLocaleString(undefined, {
      maximumFractionDigits: 2,
    });
    return (
        <text x={x + width / 2} y={y} dy={-6} fill={textColor} fontSize={12} textAnchor="middle">
            {formattedValue}
        </text>
    );
};
const MainChart = ({ data, title, theme }) => {
  const { t } = useTranslation();
  const gridColor = theme === 'dark' ? '#334155' : '#E2E8F0';
  const tickColor = theme === 'dark' ? '#94A3B8' : '#64748B';
  return (
    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl p-6 h-[480px] shadow-lg">
      <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary mb-6">{title || t('kpiProgressOverview')}</h3>
      <ResponsiveContainer width="100%" height="90%">
        <BarChart
          data={data}
          margin={{
            top: 20,
            right: 20,
            left: 10,
            bottom: 5,
          }}
        >
          <CartesianGrid strokeDasharray="3 3" stroke={gridColor} />
          <XAxis dataKey="name" stroke={tickColor} tick={{ fill: tickColor }} />
          <YAxis stroke={tickColor} tick={{ fill: tickColor }} />
          <Tooltip content={<CustomTooltip />} />
          <Bar dataKey="value" fill="#6366F1">
            <LabelList dataKey="value" content={<DataLabel theme={theme} />} />
          </Bar>
        </BarChart>
      </ResponsiveContainer>
    </div>
  );
};
// ===================================================
// END: components/MainChart.tsx
// ===================================================


// ===================================================
// START: components/DataTable.tsx
// ===================================================
const DataTable = ({ data }) => {
  const { t } = useTranslation();
  const [searchTerm, setSearchTerm] = useState('');
  const filteredData = (data || []).filter(row => {
    const lowerCaseSearchTerm = searchTerm.toLowerCase();
    return (
      row.kpi.title.toLowerCase().includes(lowerCaseSearchTerm) ||
      row.kpi.measurement.toLowerCase().includes(lowerCaseSearchTerm) ||
      row.target.toLowerCase().includes(lowerCaseSearchTerm) ||
      row.score.toLowerCase().includes(lowerCaseSearchTerm) ||
      row.result.toLowerCase().includes(lowerCaseSearchTerm)
    );
  });
  return (
    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
      <div className="p-6 border-b border-light-border dark:border-dark-border flex justify-between items-center flex-wrap gap-4">
        <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('kpiDetails')}</h3>
        <div className="relative">
          <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
          <input
            type="text"
            placeholder={t('searchDetails')}
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary w-full sm:w-64"
          />
        </div>
      </div>
      <div className="overflow-auto max-h-[600px]">
        <table className="w-full text-left">
          <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
            <tr className="border-b border-light-border dark:border-dark-border">
              <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('kpi')}</th>
              <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('target')}</th>
              <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('score')}</th>
              <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('result')}</th>
            </tr>
          </thead>
          <tbody className='divide-y divide-light-border dark:divide-dark-border'>
            {filteredData.length > 0 ? (
              filteredData.map((row, index) => (
              <tr key={index} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                <td className="p-4 max-w-xs">
                  <div className="font-medium text-light-text-primary dark:text-dark-text-primary truncate" title={row.kpi.title}>{row.kpi.title}</div>
                  <div className="text-sm text-light-text-secondary dark:text-dark-text-secondary truncate" title={row.kpi.measurement}>{row.kpi.measurement}</div>
                </td>
                <td className="p-4">
                    <div className="font-medium text-light-text-primary dark:text-dark-text-primary">{row.target}</div>
                </td>
                <td className="p-4 font-medium text-light-text-primary dark:text-dark-text-primary text-right">{row.score}</td>
                <td className="p-4 text-right">
                    <span className={`px-2 py-1 text-xs font-semibold rounded-full ${
                        row.result.toUpperCase() === 'PASS' 
                        ? 'bg-green-500/20 text-green-400' 
                        : 'bg-amber-500/20 text-amber-400'
                    }`}>
                        {row.result.toUpperCase() === 'PASS' ? t('pass') : t('inProgress')}
                    </span>
                </td>
              </tr>
              ))
            ) : (
              <tr>
                <td colSpan={4} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                  {t('noResultsFound')}
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  );
};
// ===================================================
// END: components/DataTable.tsx
// ===================================================


// ===================================================
// START: components/ConsumablesReport.tsx
// ===================================================
const ConsumablesReport = ({ tableData, kpis, chartData, onFileUpload, theme }) => {
    const { t } = useTranslation();
    const fileInputRef = useRef(null);
    const [searchTerm, setSearchTerm] = useState('');
    const handleUploadClick = () => {
        fileInputRef.current?.click();
    };
    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
        }
    };
    const headers = ['Date', 'Material', 'Description', 'Qty', 'Unit', 'Price', 'Total', 'CostCtr', 'Dept'];
    const filteredData = (tableData || []).filter(row =>
        Object.values(row).some(value =>
            String(value).toLowerCase().includes(searchTerm.toLowerCase())
        )
    );
    const topItems = useMemo(() => {
        if (!tableData || tableData.length === 0) {
            return [];
        }
        const itemStats = {};
        tableData.forEach(row => {
            const materialKey = row.material;
            if (!materialKey) return; 
            const price = parseFloat(String(row.totalPrice).replace(/[^0-9.-]+/g, "")) || 0;
            if (!itemStats[materialKey]) {
                itemStats[materialKey] = {
                    description: row.description,
                    count: 0,
                    total: 0
                };
            }
            itemStats[materialKey].count += 1;
            itemStats[materialKey].total += price;
        });
        return Object.entries(itemStats)
            .map(([material, stats]) => ({
                material,
                description: stats.description,
                count: stats.count,
                total: stats.total,
            }))
            .sort((a, b) => b.count - a.count)
            .slice(0, 5);
    }, [tableData]);
    const departmentCosts = useMemo(() => {
        if (!tableData || tableData.length === 0) {
            return [];
        }
        const costsByDept = {};
        tableData.forEach(row => {
            const price = parseFloat(String(row.totalPrice).replace(/[^0-9.-]+/g, "")) || 0;
            const dept = row.department.trim().toUpperCase();
            if (dept) {
                costsByDept[dept] = (costsByDept[dept] || 0) + price;
            }
        });
        const resultData = [
            { name: 'FILM', total: costsByDept['FILM'] || 0 },
            { name: 'SSRM', total: costsByDept['SSRM'] || 0 },
            { name: 'MH', total: costsByDept['MH'] || 0 },
            { name: 'COIL', total: costsByDept['COIL'] || 0 },
            { name: 'Admin & Incoming', total: (costsByDept['ADMIN'] || 0) + (costsByDept['INCOMING'] || 0) + (costsByDept['ADMIN&INCOMING'] || 0) }
        ].filter(d => d.total > 0);
        return resultData.sort((a, b) => b.total - a.total);
    }, [tableData]);
    return (
        <div className="container mx-auto">
             <div className="flex justify-end items-center mb-6">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept=".xlsx, .xls"
                />
                <button
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                    aria-label="Upload Consumables Excel file"
                >
                    <ArrowUpTrayIcon className="h-5 w-5" />
                    <span>{t('uploadExcel')}</span>
                </button>
            </div>
            {tableData && tableData.length > 0 ? (
                <div className="flex flex-col gap-8">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {(kpis || []).map((kpi, index) => (
                            <KPICard
                                key={index}
                                title={kpi.title}
                                value={kpi.value}
                                icon={kpi.icon}
                                color={kpi.color}
                            />
                        ))}
                    </div>
                    <MainChart data={chartData} title={t('monthlyConsumablesCost')} theme={theme} />
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top5FrequentItems')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">Description</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-center">{t('frequency')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('totalCost')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topItems.length > 0 ? topItems.map((item, index) => (
                                            <tr key={item.material} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary max-w-sm truncate" title={item.description}>{item.description}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-center">{item.count}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">
                                                    {item.total.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan={4} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                                    {t('noDataLoaded')}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('costByDepartment')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('department')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('totalCost')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {departmentCosts.length > 0 ? departmentCosts.map((item) => (
                                            <tr key={item.name} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{item.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">
                                                    {item.total.toLocaleString('th-TH', { style: 'currency', currency: 'THB' })}
                                                </td>
                                            </tr>
                                        )) : (
                                            <tr>
                                                <td colSpan={2} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                                    {t('noDataLoaded')}
                                                </td>
                                            </tr>
                                        )}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                        <div className="p-6 border-b border-light-border dark:border-dark-border flex justify-between items-center flex-wrap gap-4">
                            <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('recentTransactions')}</h3>
                             <div className="relative">
                                <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
                                <input
                                    type="text"
                                    placeholder={t('searchTransactions')}
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary w-full sm:w-64"
                                />
                            </div>
                        </div>
                        <div className="overflow-auto max-h-[600px]">
                            <table className="w-full text-left">
                                <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                    <tr className="border-b border-light-border dark:border-dark-border">
                                        {headers.map(header => (
                                            <th key={header} className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase whitespace-nowrap">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                    {filteredData.length > 0 ? (
                                        filteredData.map((row, index) => (
                                            <tr key={index} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.date}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.material}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary max-w-xs truncate" title={row.description}>{row.description}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.quantity}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.unit}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.price}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.totalPrice}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.costCenter}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.department}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan={headers.length} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                            {t('noResultsFound')}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="mt-8 flex items-center justify-center bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg p-16">
                    <div className="text-center">
                        <DocumentTextIcon className="mx-auto h-12 w-12 text-light-text-secondary dark:text-dark-text-secondary" />
                        <h3 className="mt-4 text-lg font-medium text-light-text-primary dark:text-dark-text-primary">{t('noDataLoaded')}</h3>
                        <p className="mt-1 text-sm text-light-text-secondary dark:text-dark-text-secondary">
                            {t('noDataLoadedMessageConsumables')}
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};
// ===================================================
// END: components/ConsumablesReport.tsx
// ===================================================


// ===================================================
// START: components/OTReport.tsx
// ===================================================
const OTReport = ({ tableData, kpis, chartData, onFileUpload, theme }) => {
    const { t } = useTranslation();
    const fileInputRef = useRef(null);
    const [searchTerm, setSearchTerm] = useState('');
    const handleUploadClick = () => {
        fileInputRef.current?.click();
    };
    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
        }
    };
    const headers = ['ID', 'Employee ID', 'Name', 'Position', 'Department', 'Grade', 'Status', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec', 'Total'];
    const filteredData = (tableData || []).filter(row => {
        const searchString = searchTerm.toLowerCase();
        return (
            row.id.toLowerCase().includes(searchString) ||
            row.employeeId.toLowerCase().includes(searchString) ||
            row.name.toLowerCase().includes(searchString) ||
            row.position.toLowerCase().includes(searchString) ||
            row.department.toLowerCase().includes(searchString) ||
            row.grade.toLowerCase().includes(searchString) ||
            row.status.toLowerCase().includes(searchString) ||
            String(row.totalOT).toLowerCase().includes(searchString)
        );
    });
    const topEmployees = useMemo(() => {
        if (!tableData) return [];
        return [...tableData]
            .sort((a, b) => b.totalOT - a.totalOT)
            .slice(0, 10);
    }, [tableData]);
    const topDepartments = useMemo(() => {
        if (!tableData) return [];
        const departmentTotals = {};
        tableData.forEach(row => {
            if (row.department) {
                departmentTotals[row.department] = (departmentTotals[row.department] || 0) + row.totalOT;
            }
        });
        return Object.entries(departmentTotals)
            .map(([name, total]) => ({ name, total }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 10);
    }, [tableData]);
    return (
        <div className="container mx-auto">
             <div className="flex justify-end items-center mb-6">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept=".xlsx, .xls"
                />
                <button
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                    aria-label="Upload OT Excel file"
                >
                    <ArrowUpTrayIcon className="h-5 w-5" />
                    <span>{t('uploadExcel')}</span>
                </button>
            </div>
            {tableData && tableData.length > 0 ? (
                <div className="flex flex-col gap-8">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {(kpis || []).map((kpi, index) => (
                            <KPICard
                                key={index}
                                title={kpi.title}
                                value={kpi.value}
                                icon={kpi.icon}
                                color={kpi.color}
                            />
                        ))}
                    </div>
                    <MainChart data={chartData} title={t('monthlyOvertimeHours')} theme={theme} />
                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top10EmployeesByOT')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('name')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('department')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('totalHours')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topEmployees.map((employee, index) => (
                                            <tr key={employee.employeeId} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary max-w-xs truncate" title={employee.name}>{employee.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary">{employee.department}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">{employee.totalOT.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top10DepartmentsByOT')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('department')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('totalHours')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topDepartments.map((dept, index) => (
                                            <tr key={dept.name} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary">{dept.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">{dept.total.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                        <div className="p-6 border-b border-light-border dark:border-dark-border flex justify-between items-center flex-wrap gap-4">
                            <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('employeeOTDetails')}</h3>
                            <div className="relative">
                                <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
                                <input
                                    type="text"
                                    placeholder={t('searchEmployees')}
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary w-full sm:w-64"
                                />
                            </div>
                        </div>
                        <div className="overflow-auto max-h-[600px]">
                            <table className="w-full text-left min-w-[1200px]">
                                <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                    <tr className="border-b border-light-border dark:border-dark-border">
                                        {headers.map(header => (
                                            <th key={header} className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase whitespace-nowrap">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                    {filteredData.length > 0 ? (
                                        filteredData.map((row) => (
                                            <tr key={row.employeeId} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.id}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.employeeId}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap max-w-xs truncate" title={row.name}>{row.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.position}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.department}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-center">{row.grade}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-center">{row.status}</td>
                                                {row.monthlyOT.map((ot, i) => (
                                                    <td key={i} className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{ot.toFixed(2)}</td>
                                                ))}
                                                <td className="p-4 text-sm font-bold text-brand-primary whitespace-nowrap text-right">{row.totalOT.toFixed(2)}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan={headers.length} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                                {t('noResultsFound')}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="mt-8 flex items-center justify-center bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg p-16">
                    <div className="text-center">
                        <DocumentTextIcon className="mx-auto h-12 w-12 text-light-text-secondary dark:text-dark-text-secondary" />
                        <h3 className="mt-4 text-lg font-medium text-light-text-primary dark:text-dark-text-primary">{t('noDataLoaded')}</h3>
                        <p className="mt-1 text-sm text-light-text-secondary dark:text-dark-text-secondary">
                            {t('noDataLoadedMessageOT')}
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};
// ===================================================
// END: components/OTReport.tsx
// ===================================================


// ===================================================
// START: components/LeaveReport.tsx
// ===================================================
const LeaveReport = ({ tableData, kpis, chartData, onFileUpload, theme }) => {
    const { t } = useTranslation();
    const fileInputRef = useRef(null);
    const [searchTerm, setSearchTerm] = useState('');
    const handleUploadClick = () => {
        fileInputRef.current?.click();
    };
    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
        }
    };
    const headers = ['NO.', 'EMP.', 'NAME-SURENAME', 'POSITION', 'DEPT.', 'Grade', 'STATUS', 'JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC', 'Leave (No Vac)', 'Leave (w/ Vac)', 'Vac Carried', 'Vac Entitled', 'Total Vac', 'Vac Used', 'Vac Accrued', 'Sick', 'Personal', 'Birthday', 'Other', 'Total'];
    const filteredData = (tableData || []).filter(row => {
        const searchString = searchTerm.toLowerCase();
        return (
            row.id.toLowerCase().includes(searchString) ||
            row.employeeId.toLowerCase().includes(searchString) ||
            row.name.toLowerCase().includes(searchString) ||
            row.position.toLowerCase().includes(searchString) ||
            row.department.toLowerCase().includes(searchString) ||
            row.grade.toLowerCase().includes(searchString) ||
            row.status.toLowerCase().includes(searchString) ||
            String(row.totalLeave).toLowerCase().includes(searchString)
        );
    });
    const topEmployees = useMemo(() => {
        if (!tableData) return [];
        return [...tableData]
            .sort((a, b) => b.totalLeave - a.totalLeave)
            .slice(0, 10);
    }, [tableData]);
    const topLeaveTypes = useMemo(() => {
        if (!tableData) return [];
        const leaveTypeTotals = {
            'Vacation': 0,
            'Sick Leave': 0,
            'Personal Leave': 0,
            'Birthday Leave': 0,
            'Other Leave': 0,
        };
        tableData.forEach(row => {
            leaveTypeTotals['Vacation'] += row.vacationUsed;
            leaveTypeTotals['Sick Leave'] += row.sickLeave;
            leaveTypeTotals['Personal Leave'] += row.personalLeave;
            leaveTypeTotals['Birthday Leave'] += row.birthdayLeave;
            leaveTypeTotals['Other Leave'] += row.otherLeave;
        });
        return Object.entries(leaveTypeTotals)
            .map(([name, total]) => ({ name, total }))
            .sort((a, b) => b.total - a.total);
    }, [tableData]);
    const topDepartments = useMemo(() => {
        if (!tableData) return [];
        const departmentTotals = {};
        tableData.forEach(row => {
            if (row.department) {
                departmentTotals[row.department] = (departmentTotals[row.department] || 0) + row.totalLeave;
            }
        });
        return Object.entries(departmentTotals)
            .map(([name, total]) => ({ name, total }))
            .sort((a, b) => b.total - a.total)
            .slice(0, 5);
    }, [tableData]);
    return (
        <div className="container mx-auto">
             <div className="flex justify-end items-center mb-6">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept=".xlsx, .xls"
                />
                <button
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                    aria-label="Upload Leave Excel file"
                >
                    <ArrowUpTrayIcon className="h-5 w-5" />
                    <span>{t('uploadExcel')}</span>
                </button>
            </div>
            {tableData && tableData.length > 0 ? (
                <div className="flex flex-col gap-8">
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                        {(kpis || []).map((kpi, index) => (
                            <KPICard
                                key={index}
                                title={kpi.title}
                                value={kpi.value}
                                icon={kpi.icon}
                                color={kpi.color}
                            />
                        ))}
                    </div>
                    <MainChart data={chartData} title={t('monthlyLeaveDays')} theme={theme}/>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top10LeaveEmployees')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('name')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('department')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('days')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topEmployees.map((employee, index) => (
                                            <tr key={employee.employeeId} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary max-w-[120px] truncate" title={employee.name}>{employee.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary">{employee.department}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">{employee.totalLeave.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top5LeaveTypes')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('leaveType')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('days')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topLeaveTypes.map((leaveType, index) => (
                                            <tr key={leaveType.name} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary">{leaveType.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">{leaveType.total.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                            <div className="p-6 border-b border-light-border dark:border-dark-border">
                                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('top5LeaveDepartments')}</h3>
                            </div>
                            <div className="overflow-auto">
                                <table className="w-full text-left">
                                    <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                        <tr className="border-b border-light-border dark:border-dark-border">
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">#</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase">{t('department')}</th>
                                            <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{t('days')}</th>
                                        </tr>
                                    </thead>
                                    <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                        {topDepartments.map((dept, index) => (
                                            <tr key={dept.name} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary font-medium">{index + 1}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary">{dept.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right font-semibold">{dept.total.toFixed(2)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                        <div className="p-6 border-b border-light-border dark:border-dark-border flex justify-between items-center flex-wrap gap-4">
                            <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('employeeLeaveDetails')}</h3>
                            <div className="relative">
                                <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
                                <input
                                    type="text"
                                    placeholder={t('searchEmployees')}
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary w-full sm:w-64"
                                />
                            </div>
                        </div>
                        <div className="overflow-auto max-h-[600px]">
                            <table className="w-full text-left min-w-[2800px]">
                                <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                    <tr className="border-b border-light-border dark:border-dark-border">
                                        {headers.map(header => (
                                            <th key={header} className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase whitespace-nowrap">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                    {filteredData.length > 0 ? (
                                        filteredData.map((row) => (
                                            <tr key={row.employeeId} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.id}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.employeeId}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap max-w-xs truncate" title={row.name}>{row.name}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.position}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.department}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-center">{row.grade}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-center">{row.status}</td>
                                                {row.monthlyLeave.map((leave, i) => (
                                                    <td key={i} className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{leave.toFixed(2)}</td>
                                                ))}
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.leaveWithoutVacation.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.totalLeaveWithVacation.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.vacationCarriedOver.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.vacationEntitlement.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.totalVacation.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.vacationUsed.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.vacationAccrued.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.sickLeave.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.personalLeave.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.birthdayLeave.toFixed(2)}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.otherLeave.toFixed(2)}</td>
                                                <td className="p-4 text-sm font-bold text-brand-primary whitespace-nowrap text-right">{row.totalLeave.toFixed(2)}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan={headers.length} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                                {t('noResultsFound')}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            ) : (
                <div className="mt-8 flex items-center justify-center bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg p-16">
                    <div className="text-center">
                        <DocumentTextIcon className="mx-auto h-12 w-12 text-light-text-secondary dark:text-dark-text-secondary" />
                        <h3 className="mt-4 text-lg font-medium text-light-text-primary dark:text-dark-text-primary">{t('noDataLoaded')}</h3>
                        <p className="mt-1 text-sm text-light-text-secondary dark:text-dark-text-secondary">
                            {t('noDataLoadedMessageLeave')}
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};
// ===================================================
// END: components/LeaveReport.tsx
// ===================================================


// ===================================================
// START: components/AccidentReport.tsx
// ===================================================
const AccidentReport = ({ tableData, kpis, chartData, onFileUpload, theme }) => {
    const { t } = useTranslation();
    const fileInputRef = useRef(null);
    const [searchTerm, setSearchTerm] = useState('');
    const handleUploadClick = () => {
        fileInputRef.current?.click();
    };
    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
        }
    };
    const headers = ['ลำดับ', 'วันที่เกิดเหตุ', 'เวลา', 'ความรุนแรง', 'ครั้งที่', 'ส่วนงาน', 'รหัสพนักงาน', 'ชื่อ-สกุล', 'ตำแหน่ง', 'รายละเอียด', 'สาเหตุ', 'มาตรการป้องกัน', 'มูลค่าความเสียหาย', 'การเคลม', 'การดำเนินการ', 'บทลงโทษ', 'หมายเหตุ', 'สถานที่'];
    const filteredData = (tableData || []).filter(row =>
        Object.values(row).some(value =>
            String(value).toLowerCase().includes(searchTerm.toLowerCase())
        )
    );
    return (
        <div className="container mx-auto">
             <div className="flex justify-end items-center mb-6">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept=".xlsx, .xls"
                />
                <button
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                    aria-label="Upload Accident Excel file"
                >
                    <ArrowUpTrayIcon className="h-5 w-5" />
                    <span>{t('uploadExcel')}</span>
                </button>
            </div>
            {tableData && tableData.length > 0 ? (
                <>
                    <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 mb-8">
                        {(kpis || []).map((kpi, index) => (
                            <KPICard
                                key={index}
                                title={kpi.title}
                                value={kpi.value}
                                icon={kpi.icon}
                                color={kpi.color}
                            />
                        ))}
                    </div>
                    <div className="mb-8 bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg p-6">
                        <MainChart data={chartData} title={t('accidentsByDepartment')} theme={theme} />
                    </div>
                    <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                        <div className="p-6 border-b border-light-border dark:border-dark-border flex justify-between items-center flex-wrap gap-4">
                            <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('accidentDetails')}</h3>
                            <div className="relative">
                                <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
                                <input
                                    type="text"
                                    placeholder={t('searchAccidents')}
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                    className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary w-full sm:w-64"
                                />
                            </div>
                        </div>
                        <div className="overflow-auto max-h-[600px]">
                            <table className="w-full text-left min-w-[3200px]">
                                <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                                    <tr className="border-b border-light-border dark:border-dark-border">
                                        {headers.map(header => (
                                            <th key={header} className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase whitespace-nowrap">{header}</th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                                    {filteredData.length > 0 ? (
                                        filteredData.map((row) => (
                                            <tr key={row.id} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.id}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.incidentDate}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.incidentTime}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.severity}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-center">{row.occurrence}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.department}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.employeeId}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap max-w-xs truncate" title={row.employeeName}>{row.employeeName}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap max-w-xs truncate" title={row.position}>{row.position}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-normal max-w-md">{row.details}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-normal max-w-md">{row.cause}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-normal max-w-md">{row.prevention}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap text-right">{row.damageValue.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.insuranceClaim}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-normal max-w-md">{row.actionTaken}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-normal max-w-xs">{row.penalty}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.remarks}</td>
                                                <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary whitespace-nowrap">{row.accidentLocation}</td>
                                            </tr>
                                        ))
                                    ) : (
                                        <tr>
                                            <td colSpan={headers.length} className="text-center p-8 text-light-text-secondary dark:text-dark-text-secondary">
                                                {t('noResultsFound')}
                                            </td>
                                        </tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </>
            ) : (
                <div className="mt-8 flex items-center justify-center bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg p-16">
                    <div className="text-center">
                        <DocumentTextIcon className="mx-auto h-12 w-12 text-light-text-secondary dark:text-dark-text-secondary" />
                        <h3 className="mt-4 text-lg font-medium text-light-text-primary dark:text-dark-text-primary">{t('noDataLoaded')}</h3>
                        <p className="mt-1 text-sm text-light-text-secondary dark:text-dark-text-secondary">
                            {t('noDataLoadedMessageAccident')}
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};
// ===================================================
// END: components/AccidentReport.tsx
// ===================================================


// ===================================================
// START: components/WorkloadReport.tsx
// ===================================================
const WorkloadReport = ({ data, theme, onFileUpload }) => {
    const { t } = useTranslation();
    const fileInputRef = useRef(null);
    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const gridColor = theme === 'dark' ? '#334155' : '#E2E8F0';
    const tickColor = theme === 'dark' ? '#94A3B8' : '#64748B';

    const handleUploadClick = () => {
        fileInputRef.current?.click();
    };

    const handleFileChange = (event) => {
        const file = event.target.files?.[0];
        if (file) {
            onFileUpload(file);
        }
    };
    
    const { summaryKpis, chartData } = useMemo(() => {
        if (!data || data.length === 0) {
            return { summaryKpis: [], chartData: [] };
        }

        const getTonPerHrSumForProduct = (productIndex) => {
            if (productIndex === -1 || !data[productIndex + 1]) return [];
            const tonHrSection = data[productIndex + 1];
            if (tonHrSection && tonHrSection.product === 'Ton/Person/Hr.' && tonHrSection.isSubProduct) {
                const sumRow = tonHrSection.rows.find(r => r.description === 'Sum');
                return sumRow ? sumRow.values : [];
            }
            return [];
        };

        const rawMaterialIndex = data.findIndex(p => p.product === 'Raw Material');
        const coilIndex = data.findIndex(p => p.product === 'Coil');
        const filmScrapIndex = data.findIndex(p => p.product === 'Film&Scrap');
        
        const rawMaterialTonHr = getTonPerHrSumForProduct(rawMaterialIndex);
        const coilTonHr = getTonPerHrSumForProduct(coilIndex);
        const filmTonHr = getTonPerHrSumForProduct(filmScrapIndex);

        const avg = (arr) => {
            if (!arr) return 0;
            const filtered = arr.filter(v => v !== null);
            if(filtered.length === 0) return 0;
            return filtered.reduce((a, b) => a + b, 0) / filtered.length;
        };
        
        const _summaryKpis = [
            { title: t('avgWorkloadRaw'), value: avg(rawMaterialTonHr).toFixed(2), icon: 'UserGroupIcon', color: 'text-brand-success' },
            { title: t('avgWorkloadCoil'), value: avg(coilTonHr).toFixed(2), icon: 'UserGroupIcon', color: 'text-brand-primary' },
            { title: t('avgWorkloadFilm'), value: avg(filmTonHr).toFixed(2), icon: 'UserGroupIcon', color: 'text-brand-warning' },
        ];

        const _chartData = monthNames.map((month, index) => ({
            month,
            'Raw Material': rawMaterialTonHr[index] || 0,
            'Coil': coilTonHr[index] || 0,
            'Film & Scrap': filmTonHr[index] || 0,
        }));

        return { summaryKpis: _summaryKpis, chartData: _chartData };

    }, [data, t]);


    const formatNumber = (num) => {
        if (num === null || num === undefined) return '-';
        return num.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    };

    return (
        <div className="container mx-auto flex flex-col gap-8">
            <div className="flex justify-end items-center">
                <input
                    type="file"
                    ref={fileInputRef}
                    onChange={handleFileChange}
                    className="hidden"
                    accept=".xlsx, .xls"
                />
                <button
                    onClick={handleUploadClick}
                    className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                    aria-label="Upload Workload Excel file"
                >
                    <ArrowUpTrayIcon className="h-5 w-5" />
                    <span>{t('uploadExcel')}</span>
                </button>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {summaryKpis.map((kpi, index) => (
                    <KPICard
                        key={index}
                        title={kpi.title}
                        value={kpi.value}
                        icon={kpi.icon}
                        color={kpi.color}
                    />
                ))}
            </div>
             <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl p-6 h-[480px] shadow-lg">
                <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary mb-6">{t('workloadByProduct')}</h3>
                <ResponsiveContainer width="100%" height="90%">
                    <LineChart data={chartData} margin={{ top: 5, right: 20, left: -10, bottom: 5 }}>
                        <CartesianGrid strokeDasharray="3 3" stroke={gridColor}/>
                        <XAxis dataKey="month" stroke={tickColor} tick={{ fill: tickColor }} />
                        <YAxis stroke={tickColor} tick={{ fill: tickColor }}/>
                        <Tooltip contentStyle={{
                            backgroundColor: theme === 'dark' ? '#1E293B' : '#FFFFFF',
                            borderColor: theme === 'dark' ? '#334155' : '#E2E8F0',
                            color: theme === 'dark' ? '#F8FAFC' : '#0F172A'
                        }}/>
                        <Legend wrapperStyle={{ color: tickColor }} />
                        <Line type="monotone" dataKey="Raw Material" stroke="#10B981" strokeWidth={2} />
                        <Line type="monotone" dataKey="Coil" stroke="#6366F1" strokeWidth={2} />
                        <Line type="monotone" dataKey="Film & Scrap" stroke="#F59E0B" strokeWidth={2} />
                    </LineChart>
                </ResponsiveContainer>
            </div>
            <div className="bg-light-card dark:bg-dark-card border border-light-border dark:border-dark-border rounded-xl shadow-lg flex flex-col">
                 <div className="p-6 border-b border-light-border dark:border-dark-border">
                    <h3 className="text-xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('workloadDetails')}</h3>
                </div>
                <div className="overflow-x-auto">
                    <table className="w-full text-left min-w-[1600px]">
                        <thead className="sticky top-0 bg-light-card dark:bg-dark-card z-10">
                            <tr className="border-b border-light-border dark:border-dark-border">
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase w-1/5">{t('product')}</th>
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase w-1/4">{t('description')}</th>
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase w-[80px]">{t('unit')}</th>
                                {monthNames.map(m => <th key={m} className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">{m}</th>)}
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">AVERAGE</th>
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">MIN</th>
                                <th className="p-4 text-sm font-semibold text-light-text-secondary dark:text-dark-text-secondary uppercase text-right">MAX</th>
                            </tr>
                        </thead>
                        <tbody className='divide-y divide-light-border dark:divide-dark-border'>
                           {(data || []).map((productSection, sectionIndex) => (
                                <React.Fragment key={sectionIndex}>
                                    {!productSection.isSubProduct && (
                                        <tr className="bg-slate-50 dark:bg-dark-bg/50">
                                            <td colSpan={18} className="p-4 font-bold text-lg text-brand-primary">
                                                {productSection.product}
                                            </td>
                                        </tr>
                                    )}
                                    {productSection.rows.map((row, rowIndex) => (
                                        <tr key={`${sectionIndex}-${rowIndex}`} className="hover:bg-slate-50 dark:hover:bg-dark-bg/50 transition-colors">
                                             <td>
                                                {productSection.isSubProduct && rowIndex === 0 &&
                                                    <div className="p-4 font-bold text-light-text-primary dark:text-dark-text-primary">{productSection.product}</div>
                                                }
                                            </td>
                                            <td className={`p-4 text-sm ${row.isSubRow ? 'pl-8' : 'font-semibold'} text-light-text-primary dark:text-dark-text-primary`}>{row.description}</td>
                                            <td className="p-4 text-sm text-light-text-secondary dark:text-dark-text-secondary">{row.unit}</td>
                                            {row.values.map((val, i) => <td key={i} className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right whitespace-nowrap">{formatNumber(val)}</td>)}
                                            <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right whitespace-nowrap font-medium">{formatNumber(row.average)}</td>
                                            <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right whitespace-nowrap font-medium">{formatNumber(row.min)}</td>
                                            <td className="p-4 text-sm text-light-text-primary dark:text-dark-text-primary text-right whitespace-nowrap font-medium">{formatNumber(row.max)}</td>
                                        </tr>
                                    ))}
                                </React.Fragment>
                            ))}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    );
};
// ===================================================
// END: components/WorkloadReport.tsx
// ===================================================

// ===================================================
// START: components/Sidebar.tsx
// ===================================================
const NavLink = ({ icon, text, active, onClick }) => (
  <button
    onClick={onClick}
    className={`flex items-center w-full px-4 py-3 text-lg rounded-lg transition-colors duration-200 text-left ${
      active
        ? 'bg-brand-primary text-white font-semibold shadow-lg'
        : 'text-light-text-secondary dark:text-dark-text-secondary hover:bg-slate-100 dark:hover:bg-dark-card hover:text-light-text-primary dark:hover:text-dark-text-primary'
    }`}
    aria-current={active ? 'page' : undefined}
  >
    <span className="mr-4">{icon}</span>
    {text}
  </button>
);
const Sidebar = ({ activePage, onNavigate, isOpen, onClose }) => {
  const { t } = useTranslation();
  const navItems = [
    { key: 'kpiReport', icon: <HomeIcon className="h-6 w-6" /> },
    { key: 'consumablesReport', icon: <ClipboardDocumentListIcon className="h-6 w-6" /> },
    { key: 'otReport', icon: <ClockIcon className="h-6 w-6" /> },
    { key: 'leaveReport', icon: <CalendarDaysIcon className="h-6 w-6" /> },
    { key: 'accidentReport', icon: <ExclamationTriangleIcon className="h-6 w-6" /> },
    { key: 'workloadReport', icon: <UserGroupIcon className="h-6 w-6" /> },
    { key: 'reports', icon: <ChartPieIcon className="h-6 w-6" /> },
    { key: 'documents', icon: <DocumentTextIcon className="h-6 w-6" /> },
    { key: 'settings', icon: <Cog6ToothIcon className="h-6 w-6" /> },
  ];
  return (
    <aside className={`fixed inset-y-0 left-0 z-50 w-64 flex-shrink-0 bg-light-card dark:bg-dark-card border-r border-light-border dark:border-dark-border p-6 flex flex-col transform transition-transform duration-300 ease-in-out lg:relative lg:translate-x-0 ${isOpen ? 'translate-x-0' : '-translate-x-full'}`}>
      <div className="flex items-center justify-between mb-10">
        <div className="flex items-center">
            <BoltIcon className="h-10 w-10 text-brand-primary" />
            <span className="text-2xl font-bold ml-3 text-light-text-primary dark:text-dark-text-primary">{t('analytics')}</span>
        </div>
        <button onClick={onClose} className="lg:hidden text-light-text-secondary dark:text-dark-text-secondary">
            <XMarkIcon className="h-6 w-6" />
        </button>
      </div>
      <nav className="flex-1 flex flex-col gap-3">
        {navItems.map((item) => (
          <NavLink
            key={item.key}
            icon={item.icon}
            text={t(item.key)}
            active={activePage === item.key}
            onClick={() => onNavigate(item.key)}
          />
        ))}
      </nav>
      <div className="mt-auto">
        <NavLink 
          icon={<QuestionMarkCircleIcon className="h-6 w-6" />} 
          text={t('helpCenter')}
          active={activePage === 'helpCenter'}
          onClick={() => onNavigate('helpCenter')}
        />
      </div>
    </aside>
  );
};
// ===================================================
// END: components/Sidebar.tsx
// ===================================================


// ===================================================
// START: components/Header.tsx
// ===================================================
const LiveIndicator = ({ status }) => {
    const { t } = useTranslation();
    const statusInfo = {
        connected: { textKey: 'live', color: 'text-brand-success', Icon: WifiIcon, pulse: false },
        connecting: { textKey: 'connecting', color: 'text-brand-warning', Icon: WifiIcon, pulse: true },
        error: { textKey: 'offline', color: 'text-brand-danger', Icon: WifiSlashIcon, pulse: false }
    };
    const { textKey, color, Icon, pulse } = statusInfo[status] || statusInfo.error;
    return (
        <div className={`flex items-center gap-2 ${color}`}>
            <Icon className={`h-6 w-6 ${pulse ? 'animate-pulse' : ''}`} />
            <span className="font-semibold hidden sm:inline">{t(textKey)}</span>
        </div>
    );
};
const Header = ({ onFileUpload, activePage, theme, toggleTheme, onMenuClick, connectionStatus }) => {
  const { t, language, toggleLanguage } = useTranslation();
  const fileInputRef = useRef(null);

  const handleUploadClick = () => {
    fileInputRef.current?.click();
  };

  const handleFileChange = (event) => {
    const file = event.target.files?.[0];
    if (file) {
      onFileUpload(file);
    }
  };

  return (
    <header className="bg-light-card dark:bg-dark-card border-b border-light-border dark:border-dark-border p-4 shadow-sm flex items-center justify-between">
      <div className="flex items-center">
         <button onClick={onMenuClick} className="lg:hidden mr-4 text-light-text-secondary dark:text-dark-text-secondary" aria-label="Open menu">
            <Bars3Icon className="h-6 w-6" />
        </button>
        <h1 className="text-2xl font-bold text-light-text-primary dark:text-dark-text-primary">{t(activePage)}</h1>
      </div>
      <div className="flex items-center gap-4">
        <div className="relative hidden md:block">
          <MagnifyingGlassIcon className="h-5 w-5 absolute top-1/2 left-3 -translate-y-1/2 text-light-text-secondary dark:text-dark-text-secondary" />
          <input
            type="text"
            placeholder={t('search')}
            className="bg-light-bg dark:bg-dark-bg border border-light-border dark:border-dark-border rounded-lg pl-10 pr-4 py-2 text-light-text-primary dark:text-dark-text-primary focus:outline-none focus:ring-2 focus:ring-brand-primary"
          />
        </div>
        {activePage === 'kpiReport' && (
          <>
            <input
                type="file"
                ref={fileInputRef}
                onChange={handleFileChange}
                className="hidden"
                accept=".xlsx, .xls"
            />
            <button 
                onClick={handleUploadClick}
                className="flex items-center gap-2 bg-brand-primary text-white font-semibold px-4 py-2 rounded-lg hover:bg-indigo-500 transition-colors duration-300"
                aria-label="Upload KPI data file"
            >
                <ArrowUpTrayIcon className="h-5 w-5" />
                <span className='hidden sm:inline'>{t('uploadKpiData')}</span>
            </button>
          </>
        )}
        <LiveIndicator status={connectionStatus} />
        <button
          onClick={toggleTheme}
          className="text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text-primary dark:hover:text-dark-text-primary transition-colors"
          aria-label={`Switch to ${theme === 'dark' ? 'light' : 'dark'} mode`}
        >
          {theme === 'dark' ? <SunIcon className="h-6 w-6" /> : <MoonIcon className="h-6 w-6" />}
        </button>
        <button
          onClick={toggleLanguage}
          className="text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text-primary dark:hover:text-dark-text-primary transition-colors font-semibold text-sm w-10 h-10 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-dark-border"
          aria-label="Toggle language"
        >
          {language === 'en' ? 'TH' : 'EN'}
        </button>
        <button className="relative text-light-text-secondary dark:text-dark-text-secondary hover:text-light-text-primary dark:hover:text-dark-text-primary transition-colors">
          <BellIcon className="h-6 w-6" />
          <span className="absolute -top-1 -right-1 flex h-3 w-3">
            <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-brand-secondary opacity-75"></span>
            <span className="relative inline-flex rounded-full h-3 w-3 bg-brand-secondary"></span>
          </span>
        </button>
        <div className="flex items-center gap-3">
            <img
                src="https://picsum.photos/seed/user1/40/40"
                alt="User Avatar"
                className="h-10 w-10 rounded-full border-2 border-brand-primary"
            />
            <div className='hidden sm:block'>
                <p className="font-semibold text-light-text-primary dark:text-dark-text-primary">{t('userName')}</p>
                <p className="text-sm text-light-text-secondary dark:text-dark-text-secondary">{t('userRole')}</p>
            </div>
        </div>
      </div>
    </header>
  );
};
// ===================================================
// END: components/Header.tsx
// ===================================================

// ===================================================
// START: LoadingSpinner.tsx
// ===================================================
const LoadingSpinner = () => {
    return (
        <div className="flex flex-col items-center justify-center h-screen w-full bg-light-bg dark:bg-dark-bg">
            <div className="flex items-center">
                <BoltIcon className="h-16 w-16 text-brand-primary animate-pulse" />
                <span className="text-3xl font-bold ml-4 text-light-text-secondary dark:text-dark-text-secondary">Loading Dashboard...</span>
            </div>
            <p className="mt-4 text-light-text-secondary dark:text-dark-text-secondary">Preparing your dashboard...</p>
        </div>
    );
};
// ===================================================
// END: LoadingSpinner.tsx
// ===================================================

// ===================================================
// START: Toast.tsx
// ===================================================
const Toast = ({ message, show, onDismiss }) => {
    const { t } = useTranslation();
    const [animationClass, setAnimationClass] = useState('');

    useEffect(() => {
        if (show) {
            setAnimationClass('animate-slideIn');
            const timer = setTimeout(() => {
                // Start slide out animation before removing the component
                 setAnimationClass('animate-slideOut');
            }, 4500);
            const dismissTimer = setTimeout(onDismiss, 5000);
            return () => {
                clearTimeout(timer);
                clearTimeout(dismissTimer);
            };
        } else {
            setAnimationClass('');
        }
    }, [show, onDismiss]);
    
    if (!show && animationClass === '') return null;

    return (
        <div className={`fixed bottom-5 right-5 z-50 p-4 rounded-lg shadow-2xl flex items-center gap-4 bg-light-card dark:bg-dark-card border border-brand-success ${animationClass}`}>
            <CheckCircleIcon className="h-8 w-8 text-brand-success" />
            <div>
                <p className="font-bold text-light-text-primary dark:text-dark-text-primary">{t('toastSuccess')}</p>
                <p className="text-sm text-light-text-secondary dark:text-dark-text-secondary">{message}</p>
            </div>
             <button onClick={() => setAnimationClass('animate-slideOut')} className="absolute top-2 right-2 text-light-text-secondary dark:text-dark-text-secondary">
                <XMarkIcon className="h-5 w-5"/>
            </button>
        </div>
    );
};

// ===================================================
// END: Toast.tsx
// ===================================================

// ===================================================
// START: ConnectionErrorDisplay.tsx
// ===================================================
const ConnectionErrorDisplay = ({ error }) => {
    const { t } = useTranslation();
    const securityRulesExample = `rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}`;
    return (
        <div className="flex items-center justify-center h-screen w-full bg-red-50 dark:bg-red-900/20 p-4">
            <div className="max-w-4xl w-full bg-light-card dark:bg-dark-card border border-brand-danger rounded-xl shadow-2xl p-8 text-center">
                <div className="mx-auto flex h-12 w-12 items-center justify-center rounded-full bg-red-100 dark:bg-red-900/50">
                    <ExclamationTriangleIcon className="h-8 w-8 text-brand-danger" aria-hidden="true" />
                </div>
                <h2 className="mt-4 text-2xl font-bold text-light-text-primary dark:text-dark-text-primary">{t('dbConnectionFailed')}</h2>
                <p className="mt-2 text-md text-light-text-secondary dark:text-dark-text-secondary">{t('dbConnectionFailedMessage')}</p>
                
                <div className="mt-6 text-left bg-light-bg dark:bg-dark-bg/50 p-4 rounded-lg border border-light-border dark:border-dark-border">
                    <h3 className="font-semibold text-light-text-primary dark:text-dark-text-primary">{t('errorDetails')}</h3>
                    <div className="mt-2 text-sm">
                        <p><span className="font-medium">{t('errorCode')}:</span> <code className="bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 px-1 rounded">{error.code}</code></p>
                        <p><span className="font-medium">{t('errorMessage')}:</span> <span className="text-light-text-secondary dark:text-dark-text-secondary">{error.message}</span></p>
                    </div>
                </div>

                <div className="mt-6 text-left bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg border border-brand-warning">
                    <h3 className="font-semibold text-light-text-primary dark:text-dark-text-primary">{t('possibleSolution')}</h3>
                    <p className="mt-2 text-sm text-light-text-secondary dark:text-dark-text-secondary">
                        {error.suggestion}
                    </p>
                    {error.code === 'permission-denied' && (
                        <pre className="mt-4 p-3 bg-slate-800 text-slate-200 rounded-md text-xs overflow-x-auto">
                            <code>{securityRulesExample}</code>
                        </pre>
                    )}
                </div>
            </div>
        </div>
    );
};
// ===================================================
// END: ConnectionErrorDisplay.tsx
// ===================================================


// ===================================================
// START: App.tsx
// ===================================================
const PlaceholderPage = ({ title }) => {
    const { t } = useTranslation();
    return (
        <div className="flex items-center justify-center h-full w-full">
            <div className="text-center">
            <h1 className="text-4xl font-bold text-light-text-secondary dark:text-dark-text-secondary tracking-tight">{title}</h1>
            <p className="mt-2 text-lg text-light-text-secondary dark:text-dark-text-secondary">{t('underConstruction')}</p>
            </div>
        </div>
    );
};

const App = () => {
  const { t, language } = useTranslation();
  
  // Shared Data State
  const [kpis, setKpis] = useState([]);
  const [chartData, setChartData] = useState([]);
  const [tableRows, setTableRows] = useState([]);
  const [consumablesTableData, setConsumablesTableData] = useState([]);
  const [consumablesKpis, setConsumablesKpis] = useState([]);
  const [consumablesChartData, setConsumablesChartData] = useState([]);
  const [otTableData, setOtTableData] = useState([]);
  const [otKpis, setOtKpis] = useState([]);
  const [otChartData, setOtChartData] = useState([]);
  const [leaveTableData, setLeaveTableData] = useState([]);
  const [leaveKpis, setLeaveKpis] = useState([]);
  const [leaveChartData, setLeaveChartData] = useState([]);
  const [accidentTableData, setAccidentTableData] = useState([]);
  const [accidentKpis, setAccidentKpis] = useState([]);
  const [accidentChartData, setAccidentChartData] = useState([]);
  const [workloadReportData, setWorkloadReportData] = useState([]);
  
  // UI State
  const [isLoading, setIsLoading] = useState(true);
  const [connectionStatus, setConnectionStatus] = useState('connecting'); // 'connecting', 'connected', 'error'
  const [connectionError, setConnectionError] = useState(null);
  const [activePage, setActivePage] = useState(getInitialState('activePage', 'kpiReport'));
  const [theme, setTheme] = useState(getInitialState('theme', 'dark'));
  const [isSidebarOpen, setIsSidebarOpen] = useState(false);
  const [toastMessage, setToastMessage] = useState('');

  const showToast = (message) => {
    setToastMessage(message);
  };
  
  const toggleTheme = () => {
      setTheme(prevTheme => (prevTheme === 'dark' ? 'light' : 'dark'));
  };

  useEffect(() => {
    const root = window.document.documentElement;
    const isDark = theme === 'dark';
    root.classList.remove(isDark ? 'light' : 'dark');
    root.classList.add(theme);
    localStorage.setItem('theme', JSON.stringify(theme));
  }, [theme]);

  useEffect(() => {
    localStorage.setItem('activePage', JSON.stringify(activePage));
  }, [activePage]);

  useEffect(() => {
    if (!db) {
        setConnectionStatus('error');
        setConnectionError({
            code: 'firebase-init-failed',
            message: 'Firebase could not be initialized.',
            suggestion: t('suggestionDefault')
        });
        setIsLoading(false);
        return;
    }

    const reportConfigs = [
        {
            collection: COLLECTIONS.KPI,
            setters: (data) => {
                setKpis(data?.kpis || []);
                setChartData(data?.chartData || []);
                setTableRows(data?.tableRows || []);
            },
            default: defaultData.kpi
        },
        {
            collection: COLLECTIONS.CONSUMABLES,
            setters: (data) => {
                setConsumablesTableData(data?.tableData || []);
                setConsumablesKpis(data?.kpis || []);
                setConsumablesChartData(data?.chartData || []);
            },
            default: defaultData.consumables
        },
        {
            collection: COLLECTIONS.OT,
            setters: (data) => {
                setOtTableData(data?.tableData || []);
                setOtKpis(data?.kpis || []);
                setOtChartData(data?.chartData || []);
            },
            default: defaultData.ot
        },
        {
            collection: COLLECTIONS.LEAVE,
            setters: (data) => {
                setLeaveTableData(data?.tableData || []);
                setLeaveKpis(data?.kpis || []);
                setLeaveChartData(data?.chartData || []);
            },
            default: defaultData.leave
        },
        {
            collection: COLLECTIONS.ACCIDENT,
            setters: (data) => {
                setAccidentTableData(data?.tableData || []);
                setAccidentKpis(data?.kpis || []);
                setAccidentChartData(data?.chartData || []);
            },
            default: defaultData.accident
        },
        {
            collection: COLLECTIONS.WORKLOAD,
            setters: (data) => {
                setWorkloadReportData(data?.data || []);
            },
            default: defaultData.workload
        }
    ];

    const unsubscribes = reportConfigs.map(({ collection, setters, default: defaultState }) => {
        const docRef = firebaseService.getDocRef(collection);
        return onSnapshot(docRef, (docSnap) => {
            if (connectionStatus !== 'connected') setConnectionStatus('connected');
            if (connectionError) setConnectionError(null);

            if (docSnap.exists()) {
                setters(sanitizeData(docSnap.data()));
            } else {
                console.log(`Document for ${collection} does not exist, using default data.`);
                setters(sanitizeData(defaultState));
            }
        }, (error) => {
            setConnectionStatus('error');
            console.error(`Firebase Snapshot Error on ${collection}:`, { code: error.code, message: error.message });

            let suggestionKey;
            switch (error.code) {
                case 'permission-denied': suggestionKey = 'suggestionPermissionDenied'; break;
                case 'unavailable':
                case 'deadline-exceeded': suggestionKey = 'suggestionUnavailable'; break;
                default: suggestionKey = 'suggestionDefault';
            }
            setConnectionError({ code: error.code, message: error.message, suggestion: t(suggestionKey) });
            setIsLoading(false); // Stop loading on the first error
        });
    });
    
    setIsLoading(false);

    // Cleanup all subscriptions on unmount
    return () => unsubscribes.forEach(unsub => unsub());
  }, [t]); // Depend on `t` for error message translations.

  const handleNavigate = (page) => {
    setActivePage(page);
    setIsSidebarOpen(false);
  };
  
  const handleFileUpload = async (file, processor, serviceUpdater) => {
     if (!file) return;
    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const data = e.target?.result;
        const workbook = read(data, { type: 'binary' });
        const payload = processor(workbook);
        
        if (payload) {
          await serviceUpdater(payload);
          showToast(`Data for ${t(activePage)} updated.`);
        }
      } catch (error) {
        console.error(`Error processing Excel file for ${activePage}:`, error);
        alert("Failed to process the Excel file. Please ensure it's in the correct format.");
      }
    };
    reader.readAsBinaryString(file);
  };
  
  // KPI Dashboard Processor
  const kpiProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1 });
    const rows = json.slice(1);
    if (rows.length === 0) {
      alert("Excel sheet is empty or invalid.");
      return null;
    }
    const newKpis = [];
    const newTableRows = [];
    rows.forEach((row, index) => {
      if (!row || row.length < 18 || !row[1]) return;
      const score = row[16] ? String(row[16]) : 'N/A';
      const result = row[17] ? String(row[17]) : 'N/A';
      newKpis.push({
        title: String(row[1] || 'Untitled KPI'),
        value: score,
        trend: result,
        trendDirection: result.toUpperCase() === 'PASS' ? 'up' : 'down',
        icon: ['CurrencyDollarIcon', 'ShoppingCartIcon', 'UsersIcon', 'ChartBarIcon'][index % 4],
        color: ['text-brand-success', 'text-brand-primary', 'text-brand-warning', 'text-brand-secondary'][index % 4],
      });
      newTableRows.push({
        kpi: { title: String(row[1] || 'Untitled KPI'), measurement: String(row[3] || '') },
        target: String(row[2] || 'N/A'), score, result,
      });
    });
    const firstKpiRow = rows.find(r => r && r.length >= 16) || [];
    const newChartData = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((name, index) => {
      const rawValue = firstKpiRow[4 + index];
      const numericValue = typeof rawValue === 'string' ? parseFloat(rawValue.replace('%', '')) : typeof rawValue === 'number' ? rawValue : 0;
      return { name, value: isNaN(numericValue) ? 0 : numericValue };
    });
    return { kpis: newKpis.slice(0, 4), chartData: newChartData, tableRows: newTableRows };
  };

  // Consumables Processor
  const consumablesProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1 });
    const rows = json.slice(1);
    if (rows.length === 0) { alert("Excel sheet is empty or invalid."); return null; }
    
    const newReportData = rows.map(row => {
      if (!row || row.length < 9) return null;
      let date = row[0];
      if (typeof date === 'number') {
        const jsDate = new Date(1899, 11, 30);
        jsDate.setDate(jsDate.getDate() + date);
        date = jsDate.toLocaleDateString('en-GB');
      } else if (date instanceof Date) { date = date.toLocaleDateString('en-GB'); }
      return { date: String(date || ''), material: String(row[1] || ''), description: String(row[2] || ''), quantity: String(row[3] || '0'), unit: String(row[4] || ''), price: String(row[5] || '0'), totalPrice: String(row[6] || '0'), costCenter: String(row[7] || ''), department: String(row[8] || '') };
    }).filter(item => item && item.date);

    const totalCost = newReportData.reduce((acc, row) => acc + (parseFloat(String(row.totalPrice).replace(/[^0-9.-]+/g, "")) || 0), 0);
    const newKpis = [
      { title: 'Total Cost', value: `฿${totalCost.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, icon: 'CurrencyDollarIcon', color: 'text-brand-success' },
      { title: 'Total Items', value: new Set(newReportData.map(r => r.material)).size.toLocaleString(), icon: 'ArchiveBoxIcon', color: 'text-brand-primary' },
      { title: 'Departments', value: new Set(newReportData.map(r => r.department)).size.toLocaleString(), icon: 'BuildingOfficeIcon', color: 'text-brand-warning' },
      { title: 'Transactions', value: newReportData.length.toLocaleString(), icon: 'DocumentTextIcon', color: 'text-brand-secondary' }
    ];

    const monthlyTotals = Array(12).fill(0);
    newReportData.forEach(row => {
      const month = parseInt(row.date.split('/')[1], 10) - 1;
      const price = parseFloat(String(row.totalPrice).replace(/[^0-9.-]+/g, ""));
      if (!isNaN(month) && month >= 0 && month < 12 && !isNaN(price)) monthlyTotals[month] += price;
    });

    const newChartData = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map((name, index) => ({ name, value: monthlyTotals[index] || 0 }));
    return { tableData: newReportData, kpis: newKpis, chartData: newChartData };
  };

  // OT Processor
  const otProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1 });
    const rows = json.slice(1);
    if (rows.length === 0) { alert("Excel sheet is empty or invalid."); return null; }

    const newReportData = rows.map(row => {
      if (!row || row.length < 20) return null;
      const monthlyOT = Array.from({ length: 12 }, (_, i) => parseFloat(row[7 + i]) || 0);
      const totalOT = parseFloat(row[19]) || 0;
      return { id: String(row[0] || ''), employeeId: String(row[1] || ''), name: String(row[2] || ''), position: String(row[3] || ''), department: String(row[4] || ''), grade: String(row[5] || ''), status: String(row[6] || ''), monthlyOT, totalOT };
    }).filter(item => item && item.employeeId);

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthlyTotals = Array(12).fill(0);
    const departmentTotals = {};
    let totalOTAll = 0;
    newReportData.forEach(row => {
      row.monthlyOT.forEach((ot, index) => monthlyTotals[index] += ot);
      departmentTotals[row.department] = (departmentTotals[row.department] || 0) + row.totalOT;
      totalOTAll += row.totalOT;
    });

    const newChartData = monthNames.map((name, index) => ({ name, value: parseFloat(monthlyTotals[index].toFixed(2)) }));
    const topDepartment = Object.entries(departmentTotals).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];
    const topMonthIndex = monthlyTotals.indexOf(Math.max(...monthlyTotals));

    const newKpis = [
      { title: 'Total OT Hours', value: totalOTAll.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), icon: 'ClockIcon', color: 'text-brand-primary' },
      { title: 'Total Employees', value: newReportData.length.toLocaleString(), icon: 'UsersIcon', color: 'text-brand-secondary' },
      { title: 'Top Department', value: topDepartment[0], icon: 'BuildingOfficeIcon', color: 'text-brand-warning' },
      { title: 'Top Month', value: monthNames[topMonthIndex], icon: 'ChartBarIcon', color: 'text-brand-success' }
    ];
    return { tableData: newReportData, kpis: newKpis, chartData: newChartData };
  };
  
  // Leave Processor
  const leaveProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1 });
    const rows = json.slice(1);
    if (rows.length === 0) { alert("Excel sheet is empty."); return null; }

    const getNum = val => (typeof val === 'number' ? val : parseFloat(String(val).replace(/[^0-9.-]+/g, ""))) || 0;
    const newReportData = rows.map((row, index) => {
      if (!row || row.length < 29) return null;
      const name = String(row[0] || '');
      return {
        id: String(index + 1), employeeId: `${name.replace(/\s/g, '-')}-${index}`, name, position: String(row[1] || ''),
        department: String(row[2] || ''), grade: String(row[3] || ''), status: String(row[4] || ''),
        monthlyLeave: Array.from({ length: 12 }, (_, i) => getNum(row[5 + i])),
        leaveWithoutVacation: getNum(row[17]), totalLeaveWithVacation: getNum(row[18]), vacationCarriedOver: getNum(row[19]),
        vacationEntitlement: getNum(row[20]), totalVacation: getNum(row[21]), vacationUsed: getNum(row[22]),
        vacationAccrued: getNum(row[23]), sickLeave: getNum(row[24]), personalLeave: getNum(row[25]),
        birthdayLeave: getNum(row[26]), otherLeave: getNum(row[27]), totalLeave: getNum(row[28]),
      };
    }).filter(item => item && item.name);

    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthlyTotals = Array(12).fill(0);
    const departmentTotals = {};
    const leaveTypeTotals = { 'Sick': 0, 'Personal': 0, 'Birthday': 0, 'Other': 0 };
    let totalLeaveAll = 0;
    newReportData.forEach(row => {
      row.monthlyLeave.forEach((leave, index) => monthlyTotals[index] += leave);
      departmentTotals[row.department] = (departmentTotals[row.department] || 0) + row.totalLeave;
      Object.keys(leaveTypeTotals).forEach(key => leaveTypeTotals[key] += row[`${key.toLowerCase()}Leave`]);
      totalLeaveAll += row.totalLeave;
    });

    const newChartData = monthNames.map((name, index) => ({ name, value: parseFloat(monthlyTotals[index].toFixed(2)) }));
    const topDepartment = Object.entries(departmentTotals).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];
    const topLeaveType = Object.entries(leaveTypeTotals).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];
    const topMonthIndex = monthlyTotals.indexOf(Math.max(...monthlyTotals));

    const newKpis = [
      { title: 'Total Leave Days', value: totalLeaveAll.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }), icon: 'UsersIcon', color: 'text-brand-primary' },
      { title: 'Top Leave Type', value: topLeaveType[0], icon: 'ClipboardDocumentCheckIcon', color: 'text-brand-secondary' },
      { title: 'Top Department', value: topDepartment[0], icon: 'BuildingOfficeIcon', color: 'text-brand-warning' },
      { title: 'Top Month', value: monthNames[topMonthIndex], icon: 'ChartBarIcon', color: 'text-brand-success' }
    ];
    return { tableData: newReportData, kpis: newKpis, chartData: newChartData };
  };

  // Accident Processor
  const accidentProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1, defval: '' });
    const rows = json.slice(1);
    if (rows.length === 0) { alert("Excel sheet is empty."); return null; }
    
    const getNum = val => (typeof val === 'number' ? val : parseFloat(String(val).replace(/[^0-9.-]+/g, ""))) || 0;
    const newReportData = rows.map(row => {
      if (!row || row.length < 18) return null;
      let incidentDate = row[1];
      if (typeof incidentDate === 'number' && incidentDate > 0) {
        const jsDate = new Date(1899, 11, 30);
        jsDate.setDate(jsDate.getDate() + incidentDate);
        incidentDate = jsDate.toLocaleDateString('en-GB');
      } else if (incidentDate instanceof Date) { incidentDate = incidentDate.toLocaleDateString('en-GB'); }
      return {
        id: String(row[0]), incidentDate: String(incidentDate), incidentTime: String(row[2]), severity: String(row[3]),
        occurrence: String(row[4]), department: String(row[5]), employeeId: String(row[6]), employeeName: String(row[7]),
        position: String(row[8]), details: String(row[9]), cause: String(row[10]), prevention: String(row[11]),
        damageValue: getNum(row[12]), insuranceClaim: String(row[13]), actionTaken: String(row[14]),
        penalty: String(row[15]), remarks: String(row[16]), accidentLocation: String(row[17]),
      };
    }).filter(item => item && item.id);
    
    const departmentTotals = newReportData.reduce((acc, row) => ({...acc, [row.department]: (acc[row.department] || 0) + 1}), {});
    const severityTotals = newReportData.reduce((acc, row) => ({...acc, [row.severity]: (acc[row.severity] || 0) + 1}), {});
    const totalDamage = newReportData.reduce((acc, row) => acc + row.damageValue, 0);

    const newChartData = Object.entries(departmentTotals).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
    const topDepartment = Object.entries(departmentTotals).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];
    const topSeverity = Object.entries(severityTotals).sort((a, b) => b[1] - a[1])[0] || ['N/A', 0];

    const newKpis = [
      { title: 'Total Incidents', value: newReportData.length.toLocaleString(), icon: 'ExclamationTriangleIcon', color: 'text-brand-danger' },
      { title: 'Total Damage Value', value: `฿${totalDamage.toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`, icon: 'CurrencyDollarIcon', color: 'text-brand-warning' },
      { title: 'Top Department', value: topDepartment[0], icon: 'BuildingOfficeIcon', color: 'text-brand-primary' },
      { title: 'Top Severity', value: topSeverity[0], icon: 'ClipboardDocumentCheckIcon', color: 'text-brand-secondary' }
    ];

    return { tableData: newReportData, kpis: newKpis, chartData: newChartData };
  };

  // Workload Processor
  const workloadProcessor = (workbook) => {
    const sheetName = workbook.SheetNames[0];
    const worksheet = workbook.Sheets[sheetName];
    const json = utils.sheet_to_json(worksheet, { header: 1, defval: null });
    const newWorkloadData = [];
    let currentProductSection = null;

    json.slice(1).forEach(row => {
      if (!row || row.every(cell => cell === null)) return;
      const productCell = row[0];
      const descriptionCell = row[1];

      if (productCell && typeof productCell === 'string' && productCell.trim()) {
        if (currentProductSection) newWorkloadData.push(currentProductSection);
        currentProductSection = { product: productCell.trim(), isSubProduct: productCell.trim() === 'Ton/Person/Hr.', rows: [] };
      }
      
      if (descriptionCell && typeof descriptionCell === 'string' && descriptionCell.trim() && currentProductSection) {
        const description = descriptionCell.trim();
        const values = row.slice(3, 15).map(parseValue);
        const nonSubRowPrefixes = ['Sum', 'Manpower', 'Workday', 'Working Hours', 'OT'];
        currentProductSection.rows.push({
          description, isSubRow: !nonSubRowPrefixes.some(p => description.startsWith(p)),
          unit: row[2] || '', values, average: parseValue(row[16]), min: parseValue(row[17]), max: parseValue(row[18]),
        });
      }
    });
    if (currentProductSection) newWorkloadData.push(currentProductSection);

    if (newWorkloadData.length > 0) {
      return { data: newWorkloadData };
    } else {
      alert("Could not parse workload data.");
      return null;
    }
  };


  const renderContent = () => {
    switch (activePage) {
      case 'kpiReport':
        return (
          <div className="container mx-auto">
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
              {(kpis || []).map((kpi, index) => (
                <KPICard
                  key={index}
                  title={kpi.title}
                  value={kpi.value}
                  trend={kpi.trend}
                  trendDirection={kpi.trendDirection}
                  icon={kpi.icon}
                  color={kpi.color}
                />
              ))}
            </div>
            <div className="flex flex-col gap-8">
              <MainChart data={chartData} theme={theme} />
              <DataTable data={tableRows} />
            </div>
          </div>
        );
      case 'consumablesReport':
        return <ConsumablesReport 
                  tableData={consumablesTableData} kpis={consumablesKpis} chartData={consumablesChartData}
                  onFileUpload={(file) => handleFileUpload(file, consumablesProcessor, firebaseService.updateConsumables)}
                  theme={theme}
                />;
      case 'otReport':
        return <OTReport
                  tableData={otTableData} kpis={otKpis} chartData={otChartData}
                  onFileUpload={(file) => handleFileUpload(file, otProcessor, firebaseService.updateOt)}
                  theme={theme}
                />;
      case 'leaveReport':
        return <LeaveReport
                  tableData={leaveTableData} kpis={leaveKpis} chartData={leaveChartData}
                  onFileUpload={(file) => handleFileUpload(file, leaveProcessor, firebaseService.updateLeave)}
                  theme={theme}
                />;
      case 'accidentReport':
        return <AccidentReport
                  tableData={accidentTableData} kpis={accidentKpis} chartData={accidentChartData}
                  onFileUpload={(file) => handleFileUpload(file, accidentProcessor, firebaseService.updateAccident)}
                  theme={theme}
                />;
      case 'workloadReport':
        return <WorkloadReport 
                data={workloadReportData} 
                onFileUpload={(file) => handleFileUpload(file, workloadProcessor, firebaseService.updateWorkload)} 
                theme={theme} />;
      case 'reports':
        return <PlaceholderPage title={t('reports')} />;
      case 'documents':
        return <PlaceholderPage title={t('documents')} />;
      case 'settings':
        return <PlaceholderPage title={t('settings')} />;
      case 'helpCenter':
        return <PlaceholderPage title={t('helpCenter')} />;
      default:
        return <PlaceholderPage title="Page Not Found" />;
    }
  };
  
  if (isLoading) {
      return <LoadingSpinner />;
  }

  if (connectionError) {
      return <ConnectionErrorDisplay error={connectionError} />;
  }

  return (
    <div className="flex h-screen bg-light-bg dark:bg-dark-bg text-light-text-primary dark:text-dark-text-primary">
      {isSidebarOpen && (
            <div
                className="fixed inset-0 bg-black/50 z-40 lg:hidden"
                onClick={() => setIsSidebarOpen(false)}
                aria-hidden="true"
            ></div>
        )}
      <Sidebar activePage={activePage} onNavigate={handleNavigate} isOpen={isSidebarOpen} onClose={() => setIsSidebarOpen(false)} />
      <div className="flex-1 flex flex-col overflow-hidden">
        <Header 
            onFileUpload={(file) => handleFileUpload(file, kpiProcessor, firebaseService.updateKpi)}
            activePage={activePage} 
            theme={theme} 
            toggleTheme={toggleTheme} 
            onMenuClick={() => setIsSidebarOpen(true)}
            connectionStatus={connectionStatus}
        />
        <main className="flex-1 overflow-x-hidden overflow-y-auto bg-light-bg dark:bg-dark-bg p-6 lg:p-8">
          {renderContent()}
        </main>
      </div>
      <Toast message={toastMessage} show={!!toastMessage} onDismiss={() => setToastMessage('')} />
    </div>
  );
};
// ===================================================
// END: App.tsx
// ===================================================


// ===================================================
// START: index.tsx (Entry point)
// ===================================================
const rootElement = document.getElementById('root');
if (!rootElement) {
  throw new Error("Could not find root element to mount to");
}
const root = ReactDOM.createRoot(rootElement);
root.render(
  <React.StrictMode>
    <LanguageProvider>
      <App />
    </LanguageProvider>
  </React.StrictMode>
);
// ===================================================
// END: index.tsx
// ===================================================

    </script>
  </body>
</html>
